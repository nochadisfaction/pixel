version: 1

frontend:
  environment:
    variables:
      NODE_VERSION: "22"
      PNPM_VERSION: "10.12.3"
      NODE_ENV: "production"
      ASTRO_TELEMETRY_DISABLED: "1"
      NODE_OPTIONS: "--max-old-space-size=4096"
      AWS_DEPLOYMENT: "1"

  phases:
    preBuild:
      commands:
        - echo "ðŸš€ Starting Amplify build..."
        - npm install -g pnpm@10.12.3
        - pnpm config set store-dir .pnpm-store
        - pnpm install --frozen-lockfile
        
    build:
      commands:
        - echo "ðŸ”¨ Building Astro application..."
        - cp astro.config.aws.mjs astro.config.mjs
        - AWS_DEPLOYMENT=1 pnpm run build
        - mkdir -p .amplify-hosting/compute/default
        - cp -r dist/* .amplify-hosting/
        - cp -r node_modules .amplify-hosting/compute/default/
        - echo "âœ… Build completed"
        
    postBuild:
      commands:
        - echo "ðŸ§¹ Post-build optimizations..."
        - ls -la .amplify-hosting/compute/default/
        - echo '{"status":"ok","version":"'$(node -e "console.log(require('./package.json').version)")'"}'
        
  artifacts:
    baseDirectory: .amplify-hosting
    files:
      - '**/*'
    
  cache:
    paths:
      - '.pnpm-store/**/*'
      - '.astro/**/*'